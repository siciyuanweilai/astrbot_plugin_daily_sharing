# 📅 astrbot_plugin_daily_sharing (定时主动分享所见所闻)

<div align="center">

**赋予你的 Bot “生活感” —— 集成视觉、听觉、视频、记忆的全感官主动分享插件**

</div>

## 📖 简介

**Daily Sharing** 是为 AstrBot 打造的核心主动交互组件。它打破了 Bot "被动回复" 的限制，让 Bot 像真人一样，根据 **当前时间**、**生活状态**、**聊天记忆** 和 **网络热搜**，主动向你分享生活点滴。

它不仅仅是定时发消息，它会**看群聊气氛**、**选时间段发合适的内容**、**根据穿搭发自拍**，甚至能**把自拍变成一段视频发送给你**，并且**记得自己发过什么**。

## ✨ 核心特性

### 1. 🔄 闭环上下文注入 (感谢木有知<sup>url</sup> <sup>1</sup> [<sup>1</sup>](https://github.com/muyouzhi6)大佬提供修改建议) 
*   **拒绝“断片”**：普通定时插件发送的消息往往不在 LLM 的上下文中，Bot 发完就忘。本插件会将主动发送的文案**回写到 AstrBot 的会话历史 (Conversation History) 中**。
*   **视觉语义化**：当 Bot 发送图片或视频时，插件会将**生成画面的 Prompt（画面描述）** 转化为文字（如 `[发送了一张配图: 少女在咖啡厅，穿着米色毛衣...]`）写入短期记忆。这意味着 Bot **真的“知道”自己刚才发的图里有什么**。
*   **自然追问**：
    *   *Bot 分享了一段自拍视频。*
    *   *用户回复*：“你这件衣服哪里买的？”
    *   *Bot (能读取到画面描述)*：“哈哈，这是我新买的米色毛衣，在市中心逛街看到的...”

### 2. 🧠 深度语境感知
*   **群聊防打扰策略**：插件会读取群内最近 `20` 条消息，计算“聊天热度 (Intensity)”。
    *   **谨慎模式 (Cautious)**：如果群友正在热火朝天地讨论（High Intensity），Bot 会保持安静，避免打断施法。
    *   **极简模式 (Minimal)**：只要群里有人说话，Bot 就不主动打扰，除非群冷场。
*   **生活状态融合**：联动 `life_scheduler`，Bot 会说 "刚吃完早餐，今天好冷啊"，而不是生硬的 "早上好"。 
*   **记忆延续**：联动 `memos`，私聊时尝试延续上次的话题。

### 3. 🗣️ 情感化 TTS 语音
*   **情绪感知**：自动分析文案内容，智能匹配语音情绪（Happy/Sad/Angry/Neutral）。
*   **混合发送**：支持 "图+文+语音" 混合推送，或 "视频+语音" 模式，模拟真人发语音条的习惯。

### 4. 🎨 智能 AI 绘图与构图
*   **穿搭同步**：联动 `life_scheduler`，自动使用 LLM 清洗穿搭文本，提取视觉元素（如“米色毛衣”），确保画中人物形象与设定一致。
*   **构图判断**：集成 LLM 视觉顾问，智能判断画什么：
    *   分享心情/问候 -> **画人物**（自拍、肖像）。
    *   分享新闻/推荐 -> **画场景**（书桌、咖啡厅、物品），避免无关人物乱入。
*   **环境光影**：自动根据物理时间（清晨/黄昏/深夜）和天气（雾霾/雨/雪），自动组合出光影 Prompt（例如：`黎明前的微光, 丁达尔效应, 冷色调`），杜绝 "半夜窗外是大太阳" 的违和感。

### 5. 🎬 AI 视频生成
*   **静态图转动态**：Bot 不再只能发静态图片。插件支持将生成的配图（如早安自拍、风景照）自动转换为 **5秒左右的高清动态视频**。
*   **无缝衔接**：流程完全自动化——先根据文案生成图片 -> 再根据图片生成视频 -> 发送视频消息。
*   **场景适配**：你可以在问候（Greeting）或心情（Mood）场景开启视频，让 Bot 的“早安”真的动起来，对着镜头挥手或微笑。

### 6. 📰 智能热点聚合
*   **多源支持**：知乎、微博、B站、小红书、抖音、头条、百度、腾讯（需配置 API Key）。
*   **时段偏好算法**：
    *   🌅 **早晨**：偏向 **小红书/知乎**（晨间轻阅读）。
    *   🌆 **傍晚**：偏向 **B站/微博**（下班吃瓜）。
    *   🌃 **深夜**：偏向 **抖音**（娱乐摸鱼）。
*   **自动降级**：主源获取失败会自动尝试备用源，全网瘫痪则使用 LLM 知识库兜底。

### 7. ⏰ 灵活的调度策略
*   **时段序列**：不同时间段执行不同的逻辑（早晨发问候，下午发推荐，晚上发心情）。
*   **Cron 支持**：内置预设（`morning`, `twice`）或完全自定义 Cron 表达式。

## 🧩 推荐插件生态

本插件可以独立运行，但强烈建议安装以下插件以获得完整体验：

| 插件名称 | 必需性 | 作用 | 缺失影响 |
| :--- | :--- | :--- | :--- |
| **astrbot_plugin_life_scheduler<sup>url</sup> <sup>2</sup> <sup>2</sup> [<sup>1</sup>](https://github.com/muyouzhi6/astrbot_plugin_life_scheduler)** | ⭐⭐⭐⭐⭐ | 提供虚拟生活、天气、穿搭 | 分享内容缺少生活细节，配图无法固定穿搭 |
| **astrbot_plugin_gitee_aiimg<sup>url</sup> <sup>3</sup> <sup>3</sup> [<sup>2</sup>](https://github.com/muyouzhi6/astrbot_plugin_gitee_aiimg)** | ⭐⭐⭐⭐⭐ | **提供 AI 绘图及视频生成能力** | 无法发送配图，无法生成视频 |
| **astrbot_plugin_memos_integrator<sup>url</sup> <sup>4</sup> <sup>4</sup> [<sup>3</sup>](https://github.com/zz6zz666/astrbot_plugin_memos_integrator)** | ⭐⭐⭐⭐ | 提供记忆存储与检索 | 无法引用历史话题，无法记录分享历史 |
| **astrbot_plugin_tts_emotion_router<sup>url</sup> <sup>5</sup> <sup>5</sup> [<sup>4</sup>](https://github.com/muyouzhi6/astrbot_plugin_tts_emotion_router)** | ⭐⭐⭐⭐ | 提供情感语音合成 | 无法发送语音消息 |

## ⚙️ 配置指南

请在 AstrBot WebUI 的 **插件配置** 面板中进行设置。

### 🔧 配置参数详解

#### 基础设置 (basic_conf)
| 参数名 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `sharing_cron` | String | `"0 8,20 * * *"` | Cron 表达式，控制触发时间。推荐 `twice` (早8点+晚8点)。 |
| `cron_random_delay` | Int | `0` | **随机延迟(分钟)**。设为 5 则会在定时触发后的 0-5 分钟内随机执行，模拟真人，防止风控。 |
| `topic_history_limit` | Int | `50` | **话题去重历史数**。记录最近分享过的知识/推荐/新闻，避免短期内重复。 |
| `sharing_type` | String | `"auto"` | 强制指定分享类型，或填 `auto` 使用时段序列轮询。 |

#### 视觉设置 (image_conf)
| 参数名 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `enable_ai_image` | Bool | `False` | 开启AI配图（视频生成的前提）。 |
| `enable_ai_video` | Bool | `False` | **开启AI视频生成**。开启后，Bot 会尝试将生成的图片转换为视频发送。 |
| `separate_text_and_image` | Bool | `True` | 开启后图文分开发送，更像真人。 |
| `separate_send_delay` | String | `"1.0-2.0"` | 图文分开发送时的随机间隔秒数。 |
| `image_always_include_self` | Bool | `False` | 强制所有配图都画人物（自拍模式）。 |
| `image_never_include_self` | Bool | `False` | 强制所有配图都不画人物（纯景物模式）。 |
| `appearance_prompt` | String | `""` | **外貌强制覆盖**。若填入，将忽略 LifeScheduler 的外貌设定，使用此处的 Prompt (如 `1girl, white hair`)。 |

#### 新闻设置 (news_conf)
| 参数名 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `nycnm_api_key` | String | `""` | **(重要)** 前往 柠柚 API [<sup>5</sup>](https://api.nycnm.cn/) 获取密钥。 |
| `news_random_mode` | String | `"config"` | 推荐 `time_based`，启用“时段偏好算法”。 |
| `news_items_count` | Int | `5` | 每次分享新闻时，包含的热搜条目数量。 |
| `news_share_count` | String | `"1-2"` | 让 Bot 从热搜列表中挑选几条进行详细点评。 |

#### 接收人设置 (receiver)
| 参数名 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `adapter_id` | String | `"QQ"` | **适配器 ID**。多账号/多平台环境下，指定用哪个 Bot 实例发送消息。 |
| `groups` | List | `[]` | 目标群号列表。 |
| `users` | List | `[]` | 目标私聊 QQ 号列表。 |

## 🎮 指令列表

> 指令仅限管理员使用。支持广播模式（同时发给配置的所有人）和单聊模式（只发给当前窗口）。

### 通用指令
| 指令 | 参数 | 说明 |
| :--- | :--- | :--- |
| `/分享` | `[类型]` | 立即在**当前会话**生成分享。<br>类型：`问候`, `新闻`, `心情`, `知识`, `推荐`, `自动` |
| `/分享` | `[类型] 广播` | 立即向**配置的所有群和人**发送分享。 |
| `/分享` | `状态` | 查看下一次运行时间、Cron 规则、历史记录、当前序列位置。 |
| `/分享` | `开启` / `关闭` | 启停自动定时任务。 |
| `/分享` | `查看序列` | 查看当前时间段（如早晨）会轮换发什么内容。 |
| `/分享` | `重置序列` | 重置轮换顺序，回到列表开头。 |

### 新闻专用指令
支持指定新闻源，支持获取纯图片（长图）。

| 指令 | 说明 |
| :--- | :--- |
| `/分享 新闻 [源]` | 获取指定源的热搜并点评。例如：`/分享 新闻 微博` |
| `/分享 新闻 [源] 图片` | 直接获取指定源的**热搜长图**。例如：`/分享 新闻 知乎 图片` |

#### 📰 支持的新闻源参数
在使用 `/分享 新闻 [源]` 指令时，`[源]` 支持以下名称：

| 中文名称 | 内部代号 (Key) | 特点 |
| :--- | :--- | :--- |
| **知乎** | `zhihu` | 适合早晨/上午，知识性强 |
| **微博** | `weibo` | 适合全天，吃瓜/时事 |
| **B站** | `bili` | 适合傍晚/深夜，视频娱乐 |
| **小红书** | `xiaohongshu` | 适合早晨/凌晨，生活种草 |
| **抖音** | `douyin` | 适合下午/深夜，短视频热点 |
| **头条** | `toutiao` | 硬核资讯 |
| **百度** | `baidu` | 综合搜索热点 |
| **腾讯** | `tencent` | 社会新闻 |

## 💬 自然语言交互 (LLM Trigger)

不需要死记硬背指令，直接和 Bot 聊天即可触发分享！

| 你的意图 | 你可以这样说 (自然语言) | Bot 的反应 |
| :--- | :--- | :--- |
| **看动图/视频** | “发个视频看看”<br>“动起来”<br>“早安，**要视频哦**” | **强制触发视频生成**，Bot 会发送一段生成的视频。 |
| **看新闻** | “今天有什么大瓜？”<br>“看看微博热搜” | 调用 `新闻` 模块，发送对应平台的热搜摘要。 |
| **看新闻长图** | “发张微博热搜的图片”<br>“看看知乎热榜的长图” | 调用 `新闻` 模块 (图片模式)，直接发送实时截图。 |
| **求安慰/打招呼** | “早安”<br>“我好累啊求安慰” | 调用 `问候` 模块，结合当前时间暖心回复。 |
| **涨姿势** | “讲个冷知识”<br>“有什么生活小技巧吗？” | 调用 `知识` 模块，分享百科知识或生活妙招。 |
| **求推荐** | “书荒了推荐本书”<br>“推荐一部好看的电影” | 调用 `推荐` 模块，根据分类推荐高分作品。 |

## 🛠️ 常见问题

**Q: 日志提示 `[DailySharing] 无法生成视频` 或 `Gitee插件版本过低`？**
> A: 视频生成功能依赖 `astrbot_plugin_gitee_aiimg` 插件的 `video` 模块。请确保该绘图插件已更新到最新版本，且在绘图插件的配置中启用并正确配置了支持视频生成的模型。

**Q: 配置了 Cron 为什么没有准时触发？**
> A: 请检查 `basic_conf` 中的 `cron_random_delay`（随机延迟）。如果设置了非 0 值（例如 10），Bot 会在定点后的 0-10 分钟内随机找时间发送，这是为了模拟真人行为，属正常现象。

**Q: 视频生成失败会怎样？**
> A: 插件有降级机制。如果视频生成失败（如 API 超时），Bot 会自动退化为发送静态图片，保证消息能发出去。
