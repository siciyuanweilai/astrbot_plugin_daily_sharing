# 📅 astrbot_plugin_daily_sharing (定时主动分享所见所闻)

<div align="center">

**赋予你的 Bot “生活感” —— 集成视觉、听觉、视频、记忆的全感官主动分享插件**

</div>

## 📖 简介

**Daily Sharing** 是为 AstrBot 打造的核心主动交互组件。它打破了 Bot "被动回复" 的限制，让 Bot 像真人一样，根据 **当前时间**、**生活状态**、**聊天记忆** 和 **网络热搜**，主动向你分享生活点滴。

它不仅仅是定时发消息，它会**看群聊气氛**、**选时间段发合适的内容**、**根据穿搭发自拍**，甚至能**把自拍变成一段视频发送给你**，并且**记得自己发过什么**。

## 更新日志

### v3.0.0
**🧠 核心升级：全链路 Agent 化 (Agentic Workflow)**

**重构 配图生成逻辑 (ImageService)：**
- 弃用旧的模板拼接，新增 _agent_extract_visuals 思考链路。
- 引入 JSON 结构化提取：LLM 现在会输出包含 subject, environment, lighting, outfit, action 的 JSON 数据。
- 新增 “文案 vs 日程” 冲突仲裁机制：智能判断是优先画“文案里描述的地点”（如：我在海边）还是“日程表里的地点”（如：办公室）。
- 效果：大幅提升配图与文案的一致性，减少“图文不符”的幻觉。

**重构 选题与情感逻辑 (ContentService & ContextService)：**
- 新增 选题 Agent (_agent_brainstorm_topic)：不再从死板的列表里随机选词，而是让 LLM 结合历史记录“头脑风暴”出新颖的冷知识或推荐作品。
- 新增 情感分析 Agent (_agent_analyze_sentiment)：TTS 语音的情感（happy/sad/angry）不再依赖简单的关键词匹配，而是由 LLM 阅读理解全文后判定。
- 新增 “共鸣策略” (Resonance Strategy)：心情文案生成引入深度心理学提示词（如：忙碌时寻找“缝隙中的安宁”、休闲时传递“允许暂停的松弛感”）。

**🕒 细粒度时间管理**

**新增 “深夜” 时段：**
- 将原本的 Night (19-24) 拆分为 Night (19-22) 和 Late Night (22-24)。
- 适配更精准的作息：22点后进入“深夜模式”，配图光影强制转为“幽暗/局部点光”，文案强制带晚安，推荐内容偏向助眠/情感/吃瓜。

**🛠️ 交互与系统稳定性**

**优化 指令作用域：**
- /分享 [类型]：现在默认 只发送给当前对话窗口（方便管理员私下测试效果）。
- /分享 [类型] 广播：新增广播参数，才会像定时任务一样发送给所有配置的群/人。

**新增 优雅停机机制：**
- 引入 _bg_tasks 任务追踪集合。
- 插件卸载/重载时，自动取消所有正在运行的后台异步任务，防止残留的“僵尸任务”在后台继续占用资源或报错。

### v2.0.0 
**核心架构升级：异步任务流**

重构 daily_share_tool 执行逻辑：
- 变更前：LLM 工具调用 -> 等待画图/TTS/文案 -> 返回结果 (容易导致 LLM 超时)。
- 变更后：LLM 工具调用 -> 立即返回空字符串 -> 后台 asyncio.create_task 异步执行所有生成与发送逻辑。
- 效果：大幅提升响应速度，彻底解决因绘图或生成语音时间过长导致的工具调用超时错误。

**🎬 新功能：AI 视频生成**

新增 视频生成链路：
- 支持从生成的配图进一步生成视频。
- 自动注入动态提示词：如 "cinematic motion, slow pan" 等，让静态分享图动起来。
- 工具参数更新：daily_share 工具新增 need_video 参数，支持自然语言触发（如“生成视频”、“动起来”）。

### v1.0.0 
**初始发布：每日日常分享**

**自动化调度系统：**
- 支持 Cron 表达式定时触发任务（默认早晚）。
- 支持 时间段感知：将一天划分为凌晨、早晨、上午、下午、傍晚、深夜，通过 TimePeriod 枚举管理。
- 支持 随机延迟策略：定时任务触发后可随机等待一段时间再发送，增加拟人感。
- 支持 智能序列：根据不同时段自动轮询分享类型（如早上发问候，上午发新闻，晚上发心情）。

**多模态内容生成：**
- 📝 智能文案：基于 LLM 生成，集成 Life Scheduler（天气/穿搭/日程）和 Chat History（聊天历史），拒绝尴尬开场。
- 🎨 智能配图：根据文案自动生成绘画提示词。支持从生活上下文中提取“穿搭”信息，智能判断是否需要人物出镜（画人 vs 画景）。
- 🗣️ 情感语音：集成 TTS 插件，根据分享类型和时间段自动注入情绪（happy/sad/neutral/angry）。

**外部数据聚合：**
- 📰 全网热搜：聚合 8 大平台（微博、知乎、B站、抖音、小红书、头条、百度、腾讯）热榜。
- 📚 百科/知识库：集成百科 API，支持“冷知识”和“推荐”类内容的资料查询与 LLM 润色。

## ✨ 核心特性

### 1. 🔄 闭环上下文注入 (感谢木有知<sup>url</sup> <sup>1</sup> [<sup>1</sup>](https://github.com/muyouzhi6)大佬提供修改建议) 
*   **拒绝“断片”**：普通定时插件发送的消息往往不在 LLM 的上下文中，Bot 发完就忘。本插件会将主动发送的文案**回写到 AstrBot 的会话历史 (Conversation History) 中**。
*   **视觉语义化**：当 Bot 发送图片或视频时，插件会将**生成画面的 Prompt（画面描述）** 转化为文字（如 `[发送了一张配图: 少女在咖啡厅，穿着米色毛衣...]`）写入短期记忆。
*   **自然追问**：
    *   *Bot 分享了一段自拍视频。*
    *   *用户回复*：“你这件衣服哪里买的？”
    *   *Bot (能读取到画面描述)*：“哈哈，这是我新买的米色毛衣，在市中心逛街看到的...”

### 2. 🧠 深度语境感知 (Context Aware)
*   **拒绝 KY (KY规避)**：在群聊中，插件会自动分析**聊天热度**。如果群友正在热火朝天地讨论（High Intensity），Bot 会保持安静，避免打断施法。
*   **生活状态融合**：联动 `life_scheduler`，Bot 会说 "刚吃完早餐，今天好冷啊"，而不是生硬的 "早上好"。
*   **记忆延续**：联动 `memos`，私聊时尝试延续上次的话题。    

### 3. 🗣️ 情感化 TTS 语音
*   **情绪感知**：自动分析文案内容，智能匹配语音情绪。
*   **混合发送**：支持 "图+文+语音" 混合推送，或 "视频+语音" 模式，模拟真人发语音条的习惯。

### 4. 🎨 智能 AI 绘图与构图
*   **穿搭同步**：联动 `life_scheduler`，自动从 Bot 的生活日程中提取当天的穿搭，确保画中人物形象与设定一致。
*   **构图判断**：集成 LLM 视觉顾问，智能判断画什么：
    *   分享心情/问候 -> **画人物**（自拍、肖像）。
    *   分享新闻/推荐 -> **画场景**（书桌、咖啡厅、物品），避免无关人物乱入。
*   **环境光影**：自动根据物理时间（清晨/黄昏/深夜）调整画面的光影 Prompt，杜绝 "半夜窗外是大太阳" 的违和感。

### 5. 🎬 AI 视频生成
*   **静态图转动态**：Bot 不再只能发静态图片。插件支持将生成的配图（如早安自拍、风景照）自动转换为 **5秒左右的高清动态视频**。
*   **无缝衔接**：流程完全自动化——先根据文案生成图片 -> 再根据图片生成视频 -> 发送视频消息。
*   **场景适配**：你可以在问候（Greeting）或心情（Mood）场景开启视频，让 Bot 的“早安”真的动起来，对着镜头挥手或微笑。

### 6. 📰 智能热点聚合
*   **多源支持**：知乎、微博、B站、小红书、抖音（需配置 API Key）。
*   **时段偏好算法**：
    *   🌅 **早晨**：偏向 **小红书/知乎**（晨间轻阅读）。
    *   🌆 **傍晚**：偏向 **B站/微博**（下班吃瓜）。
    *   🌃 **深夜**：偏向 **抖音**（娱乐摸鱼）。
*   **自动降级**：主源获取失败会自动尝试备用源，全网瘫痪则使用 LLM 知识库兜底。

### 7. ⏰ 灵活的调度策略
*   **时段序列**：不同时间段执行不同的逻辑（早晨发问候，下午发推荐，晚上发心情）。
*   **Cron 支持**：内置预设（`morning`, `twice`）或完全自定义 Cron 表达式。

## 🧩 推荐插件生态

本插件可以独立运行，但强烈建议安装以下插件以获得完整体验：

| 插件名称 | 必需性 | 作用 | 缺失影响 |
| :--- | :--- | :--- | :--- |
| **astrbot_plugin_life_scheduler<sup>url</sup> <sup>2</sup> [<sup>2</sup>](https://github.com/muyouzhi6/astrbot_plugin_life_scheduler)** | ⭐⭐⭐⭐⭐ | 提供虚拟生活、天气、穿搭 | 分享内容缺少生活细节，配图无法固定穿搭 |
| **astrbot_plugin_gitee_aiimg<sup>url</sup> <sup>3</sup> [<sup>3</sup>](https://github.com/muyouzhi6/astrbot_plugin_gitee_aiimg)** | ⭐⭐⭐⭐⭐ | **提供 AI 绘图及视频生成能力** | 无法发送配图，无法生成视频 |
| **astrbot_plugin_memos_integrator<sup>url</sup> <sup>4</sup> [<sup>4</sup>](https://github.com/zz6zz666/astrbot_plugin_memos_integrator)** | ⭐⭐⭐⭐ | 提供记忆存储与检索 | 无法引用历史话题，无法记录分享历史 |
| **astrbot_plugin_tts_emotion_router<sup>url</sup> <sup>5</sup> [<sup>5</sup>](https://github.com/muyouzhi6/astrbot_plugin_tts_emotion_router)** | ⭐⭐⭐⭐ | 提供情感语音合成 | 无法发送语音消息 |

## ⚙️ 配置指南

请在 AstrBot WebUI 的 **插件配置** 面板中进行设置。

### 1. 基础与推送 (Basic & Receiver)
*   **推送目标**：填入需要自动推送的群号或 QQ 号。
*   **sharing_cron**：定时规则，推荐 `twice` (早8点+晚8点)。
*   **sharing_type**：推荐 `auto`，让插件根据时间自动轮换分享类型。

### 2. 视觉与视频 (Image & Video)
*   **image_conf -> enable_ai_image**：开启AI配图（视频生成的前提）。
*   **image_conf -> enable_ai_video**：**开启AI视频生成**。开启后，Bot 会尝试将生成的图片转换为视频发送。
*   **image_conf -> video_enabled_types**：指定哪些类型允许转视频（建议仅勾选 `greeting`, `mood`，避免新闻类生成视频浪费资源）。
*   **image_conf -> separate_text_and_image**：开启后图文分开发送，更像真人。

### 3. 新闻源 (News)
*   **nycnm_api_key**：**(重要)** 前往 柠柚 API <sup>url</sup> <sup>6</sup> [<sup>6</sup>](https://api.nycnm.cn/) 获取密钥。不填则无法获取真实热搜，仅能依靠 LLM 瞎编。
*   **news_random_mode**：推荐 `time_based`，启用上述的“时段偏好算法”。

### 4. 听觉 (TTS)
*   **tts_conf -> enable_tts**：开启语音。
*   **tts_conf -> prefer_audio_only**：开启后，如果语音生成成功，将**不再发送文字**（仅发语音+图/视频），沉浸感更强。

## 💬 自然语言交互 (LLM Trigger)

得益于 AstrBot 的函数调用能力，你不需要死记硬背指令，直接和 Bot 聊天即可触发分享！

| 你的意图 | 你可以这样说 (自然语言) | Bot 的反应 |
| :--- | :--- | :--- |
| **看动图/视频** | “发个视频看看”<br>“动起来”<br>“早安，**要视频哦**” | **强制触发视频生成**，Bot 会发送一段生成的视频。 |
| **看新闻** | “今天有什么大瓜？”<br>“看看微博热搜” | 调用 `新闻` 模块，发送对应平台的热搜摘要。 |
| **看新闻长图** | “发张微博热搜的图片”<br>“看看知乎热榜的长图” | 调用 `新闻` 模块 (图片模式)，直接发送实时截图。 |
| **求安慰/打招呼** | “早安”<br>“我好累啊求安慰” | 调用 `问候` 模块，结合当前时间暖心回复。 |
| **涨姿势** | “讲个冷知识”<br>“有什么生活小技巧吗？” | 调用 `知识` 模块，分享百科知识或生活妙招。 |
| **求推荐** | “书荒了推荐本书”<br>“推荐一部好看的电影” | 调用 `推荐` 模块，根据分类推荐高分作品。 |
| **听碎碎念** | “你现在心情怎么样？”<br>“你在干嘛？” | 调用 `心情` 模块，结合 Bot 的生活日程分享状态。 |

> **提示**：如果想让 Bot 发语音或配图，也可以直接说：“讲个冷知识，**要发语音哦**” 或 “分享下心情，**带张自拍**”。

## 🎮 指令列表

> 指令仅限管理员使用。

| 指令 | 参数 | 说明 |
| :--- | :--- | :--- |
| `/分享` | `[类型]` | 立即手动触发一次。<br>类型：`问候`, `新闻`, `心情`, `知识`, `推荐`, `自动` |
| `/分享` | `状态` | 查看下一次运行时间、Cron 规则、历史记录 |
| `/分享` | `开启` / `关闭` | 启停自动定时任务 |
| `/分享` | `查看序列` | 查看当前时间段（如早晨）会轮换发什么内容 |
| `/分享` | `重置序列` | 重置轮换顺序，回到列表开头 |

## 🌰 效果示例

#### 场景：早安问候 (私聊，全功能开启)
> **Context**: LifeScheduler 显示正在喝咖啡，穿米色毛衣。TTS 判定情绪为 Happy。`enable_ai_video` 为 True。
>
> **Bot (语音消息 🔊 10s)**: "早安呀！今天的阳光太棒了，我刚冲好咖啡，你也记得吃早餐哦！"
> **Bot (视频 🎬 5s)**: [一段高画质视频：阳光洒在脸上，Bot 穿着米色毛衣，端起咖啡杯轻轻吹气，头发随微风飘动]

#### 场景：晚间新闻 (群聊)
> **Context**: 此时是 20:00，根据偏好选择了 **B站热搜**。
>
> **Bot (文字)**: "📺 忙里偷闲刷了下 B站，【黑神话·悟空】的新演示太燃了吧！🔥 那个打击感真的绝了，有人一起蹲首发吗？"
> **Bot (图片)**: [一张游戏风格的场景渲染图，Bot 坐在电脑前的背影，**无正脸**]
> *(注：新闻类默认不开启视频生成，仅发送图片)*

#### 场景：群聊静默 (防打扰)
> **Context**: 群里 5 分钟内刷了 99+ 条消息。
>
> **Log**: `[DailySharing] 监测到群聊热度过高 (High Intensity)，跳过本次主动分享。`
> **(Bot 保持沉默，不打断群友施法)**

## 🛠️ 常见问题

**Q: 为什么 Bot 总是发“知乎”新闻？**
> A: 请检查 `nycnm_api_key` 是否配置。如果未配置或 Key 失效，为了保证稳定性，插件可能会降级到默认源或模拟数据。

**Q: 我问 Bot 刚才发的图/视频里有什么，它为什么能回答上来？**
> A: 因为插件启用了 **上下文回写** 功能。当 Bot 生成视觉内容时，插件会将生成画面的 Prompt 记录在对话历史中。对 LLM 来说，它虽然看不见，但它“读”到了画面的详细描述。

**Q: 为什么开启了视频却没有发送？**
> A: 1. 确保安装了 `astrbot_plugin_gitee_aiimg` 且配置了支持视频生成的模型。2. 检查 `video_enabled_types` 配置，默认可能只开启了 `greeting` 和 `mood`。3. 视频生成需要时间，Bot 可能会先发文字，稍等片刻后再发视频。

**Q: 视频生成失败会怎样？**
> A: 插件有降级机制。如果视频生成失败（如 API 超时），Bot 会自动退化为发送静态图片，保证消息能发出去。
